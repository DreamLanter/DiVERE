name: Build DiVERE Application (PyInstaller)

on:
  push:
    branches: ['**']
  workflow_dispatch:
  
jobs:
  build:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        include:
          - os: macos-14
            platform: macos
            arch: arm64
            extension: ''
          - os: windows-latest
            platform: windows
            arch: x64
            extension: .exe

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies (macOS)
      if: matrix.platform == 'macos'
      run: |
        brew install openssl readline sqlite3 xz zlib libomp

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip wheel setuptools
        pip install -r requirements.txt
        # 明确确保 onnxruntime 安装（arm64 原生包）
        if [ "${{ matrix.arch }}" = "arm64" ]; then
          pip install --upgrade onnxruntime
        fi
        # 可选GPU依赖
        if [ "${{ matrix.platform }}" = "macos" ]; then
          pip install pyobjc-framework-Metal pyobjc-framework-MetalPerformanceShaders || true
        fi
        pip install pyopencl || true
        # Windows 上可选尝试安装 CuPy（CUDA），在 GitHub 托管 runner 上通常无 NVIDIA 驱动，仅供自托管机使用
        if [ "${{ matrix.platform }}" = "windows" ]; then
          echo "Attempting to install CuPy (CUDA) wheels..."
          pip install cupy-cuda12x || \
          pip install cupy-cuda11x || \
          pip install cupy-cuda102 || \
          echo "CuPy CUDA wheels not installed (no GPU/driver on runner)."
        fi
        echo "--- Installed packages ---"
        pip list | sed -n '1,200p'
        echo "--------------------------"

    - name: Check required imports
      run: |
        python - <<'PY'
        import importlib, sys
        required = [
          'PySide6', 'numpy', 'cv2', 'PIL', 'scipy', 'imageio', 'colour', 'onnxruntime', 'sklearn'
        ]
        missing = []
        for m in required:
            try:
                importlib.import_module(m)
            except Exception as e:
                missing.append((m, repr(e)))
        if missing:
            print('Missing modules:')
            for name, err in missing:
                print(f'- {name}: {err}')
            sys.exit(1)
        print('All required imports are available.')
        PY

    - name: Install PyInstaller
      run: |
        pip install pyinstaller pyinstaller-hooks-contrib
        python -c "import PyInstaller; print('PyInstaller', PyInstaller.__version__)"

    - name: Build with PyInstaller
      run: |
        rm -rf build dist *.spec || true
        # PyInstaller --add-data 在 Windows 使用分号 ;，在 macOS 使用冒号 :
        DATA_SEP=':'
        if [ "${{ matrix.platform }}" = "windows" ]; then DATA_SEP=';'; fi
        python -m PyInstaller \
          -y --clean --noconfirm \
          --windowed \
          --name "DiVERE" \
          --add-data "divere/config${DATA_SEP}config" \
          --add-data "divere/models${DATA_SEP}models" \
          --collect-all onnxruntime \
          --collect-all cupy \
          --collect-submodules sklearn \
          --hidden-import "sklearn.linear_model" \
          --hidden-import "scipy.interpolate" \
          --hidden-import "scipy.optimize" \
          --hidden-import "scipy.ndimage" \
          divere/__main__.py
        echo "✅ PyInstaller build completed"

    - name: Relocate resources into Contents/MacOS (for runtime compatibility)
      if: matrix.platform == 'macos'
      run: |
        app_bundle=$(find dist -type d -name "*.app" | head -1)
        if [ -z "$app_bundle" ]; then
          echo "::error::No .app bundle found after build." && exit 1
        fi
        resources_dir="$app_bundle/Contents/Resources"
        macos_dir="$app_bundle/Contents/MacOS"
        mkdir -p "$macos_dir"
        if [ -d "$resources_dir/config" ]; then
          rm -rf "$macos_dir/config"
          cp -a "$resources_dir/config" "$macos_dir/config"
        fi
        if [ -d "$resources_dir/models" ]; then
          rm -rf "$macos_dir/models"
          cp -a "$resources_dir/models" "$macos_dir/models"
        fi
        echo "Relocated resources to Contents/MacOS"

    - name: Ad-hoc sign app bundle (deep)
      if: matrix.platform == 'macos'
      run: |
        app_bundle=$(find dist -type d -name "*.app" | head -1)
        if [ -z "$app_bundle" ]; then
          echo "::error::No .app bundle found for codesign." && exit 1
        fi
        echo "Codesigning (ad-hoc) $app_bundle"
        codesign --force --deep -s - "$app_bundle" || true
        echo "Verify codesign (may show 'rejected' due to no notarization)"
        codesign -dv "$app_bundle" 2>&1 | sed -n '1,200p'

    - name: Verify bundle contents (macOS)
      if: matrix.platform == 'macos'
      run: |
        app_bundle=$(find dist -type d -name "*.app" | head -1)
        if [ -z "$app_bundle" ]; then
          echo "::error::No .app bundle found." && exit 1
        fi
        echo "App bundle: $app_bundle"

        echo "--- Listing key dylib files in bundle (onnxruntime) ---"
        find "$app_bundle" -name "*onnxruntime*.dylib" | sed -n '1,80p' || true

        echo "--- Verifying data files in bundle ---"
        required_files=(
          "Contents/MacOS/config/app_settings.json"
          "Contents/MacOS/config/colorspace/ACEScg.json"
          "Contents/MacOS/config/colorspace/Film_KodakRGB_Linear.icc"
          "Contents/MacOS/config/curves/Kodak_Endura_Paper.json"
          "Contents/MacOS/config/matrices/Identity.json"
          "Contents/MacOS/models/net_awb.onnx"
        )
        missing=0
        for f in "${required_files[@]}"; do
          if [ ! -f "$app_bundle/$f" ]; then
            echo "::error::Missing: $f"
            missing=1
          fi
        done
        if [ $missing -ne 0 ]; then
          echo "Required data files missing in app bundle" && exit 1
        fi
        echo "✅ Data verification passed."

    - name: Package macOS App (zip)
      if: matrix.platform == 'macos'
      run: |
        app_bundle=$(find dist -type d -name "*.app" | head -1)
        cd dist
        ditto -c -k --sequesterRsrc --keepParent "$(basename "$app_bundle")" "DiVERE-${{ matrix.platform }}-${{ matrix.arch }}.zip"

    - name: Package Windows App (zip)
      if: matrix.platform == 'windows'
      run: |
        set -e
        if [ ! -d "dist/DiVERE" ]; then
          echo "::error::DiVERE folder not found under dist" && ls -la dist && exit 1
        fi
        cd dist
        zip -r "DiVERE-${{ matrix.platform }}-${{ matrix.arch }}.zip" "DiVERE"

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: DiVERE-${{ matrix.platform }}-${{ matrix.arch }}
        path: dist/DiVERE-${{ matrix.platform }}-${{ matrix.arch }}.zip
