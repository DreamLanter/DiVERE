# 色卡选择器重构 TODO 清单

## 问题分析
色卡选择器当前存在以下问题：
1. `_draw_colorchecker_overlay` 方法混合了绘制和计算逻辑
2. 使用了未定义的变量 `H_img`, `W_img`, `arr`
3. 缺少绘制24个色块网格的代码
4. 方法试图返回数据而不是只绘制
5. 色块提取逻辑与UI绘制逻辑混在一起

## 重构任务清单

### 第一阶段：代码结构重构 ✅
- [x] 重构 `_draw_colorchecker_overlay` 方法，使其只负责绘制UI元素
- [x] 创建新的 `_extract_colorchecker_patches` 方法处理色块数据提取
- [x] 创建新的 `_draw_colorchecker_grid` 方法绘制4x6色块网格
- [x] 创建新的 `_draw_reference_colors` 方法绘制参考色块

### 第二阶段：绘制逻辑修复 ✅
- [x] 修复 `_draw_colorchecker_overlay` 中的变量引用问题
- [x] 实现完整的24个色块网格绘制
- [x] 添加色块边框和标签绘制
- [x] 实现参考色块的显示（可选）

### 第三阶段：数据提取逻辑 ✅
- [x] 实现 `_extract_colorchecker_patches` 方法
- [x] 修复透视变换和色块提取逻辑
- [x] 确保XYZ计算正确
- [x] 添加错误处理和边界检查

### 第四阶段：测试和验证 ⏳
- [ ] 测试色卡选择器的显示/隐藏
- [ ] 验证选色框和参考色块是否正确显示
- [ ] 测试色块提取功能
- [ ] 检查性能是否正常

## 新增优化任务：色卡选择器UI优化 🆕

### 优化目标
- 移除色块标签（A1, A2, ..., D6）
- 将参考色块嵌入到网格内，跟随网格变换
- 统一绘制逻辑，提高性能和可维护性

### 具体任务
- [x] **移除色块标签绘制**
  - 在 `_draw_colorchecker_grid` 中删除标签绘制代码
  - 保持网格结构清晰

- [x] **重构参考色块绘制逻辑**
  - 修改 `_draw_colorchecker_grid` 方法
  - 在每个网格单元内填充对应的参考色块
  - 确保参考色块跟随网格透视变换

- [x] **优化绘制性能**
  - 合并网格和参考色块的绘制逻辑
  - 减少重复的透视变换计算
  - 优化绘制顺序

- [x] **简化方法结构**
  - 移除独立的 `_draw_reference_colors` 方法
  - 在 `_draw_colorchecker_grid` 中统一处理
  - 更新 `_draw_colorchecker_overlay` 的调用

## 新增优化任务：色卡选择器视觉优化和UCS Diagram更新 🆕

### 优化目标
- 调整reference color的大小和透明度
- 更新手动调整色彩空间的UCS Diagram

### 具体任务
- [x] **调整reference color视觉效果**
  - 让reference color比grid小25%（内缩边距）
  - 移除reference color的透明度（设置为255）
  - 确保网格线清晰可见
  - 移除reference color的黄色边框，只保留网格线

- [x] **更新UCS Diagram联动**
  - 当输入色彩空间改变时，自动更新UCS Diagram
  - 反映新的色彩空间基色坐标
  - 同步IDT Gamma值显示

### 实现细节
1. **网格单元填充**：在每个网格单元内绘制不透明的参考色块
2. **变换一致性**：参考色块使用与网格相同的透视变换矩阵
3. **视觉优化**：参考色块比网格小25%，无透明度，网格线清晰可见
4. **性能优化**：避免重复计算透视变换
5. **UCS Diagram联动**：色彩空间变化时自动更新基色坐标和IDT Gamma

## 文件修改清单
- `divere/ui/preview_widget.py` - 主要重构文件 ✅
  - 重构 `_draw_colorchecker_overlay` 方法 ✅
  - 添加新的绘制和数据提取方法 ✅
  - 修复变量引用问题 ✅
  - **新增**：优化色卡网格和参考色块的绘制逻辑 ✅

## 重构完成的功能
1. **UI绘制分离**：`_draw_colorchecker_overlay` 现在只负责绘制UI元素
2. **数据提取独立**：`_extract_colorchecker_patches` 专门处理色块数据提取
3. **网格绘制完整**：`_draw_colorchecker_grid` 绘制完整的4x6色块网格
4. **参考色块显示**：`_draw_reference_colors` 在右侧显示参考色块
5. **代码结构清晰**：绘制逻辑与数据提取逻辑完全分离

## 注意事项
- 保持现有的信号连接和UI交互逻辑不变
- 确保色卡选择器的启用/禁用状态正确
- 保持与参数面板的联动功能
- 确保绘制性能不受影响

## 下一步
1. 完成色卡选择器UI优化任务
2. 进行测试和验证，确保色卡选择器功能正常工作
3. 验证参考色块跟随网格变换的效果

## 新增优化任务：FFF文件智能分类系统 🆕

### 优化目标
- 为fff文件（及未来其他文件类型）提供智能默认预设加载
- 实现完全解耦的文件分类和预设加载系统
- 支持所有使用场景：新文件、重置、crop聚焦重置

### 具体任务

#### 第一阶段：核心模块实现 ✅
- [x] **创建配置文件**
  - 创建 `config/file_classification_rules.json`
  - 定义fff文件分类规则
  - 设置fallback预设

- [x] **实现SmartFileClassifier**
  - 创建 `utils/smart_file_classifier.py`
  - 实现文件信息提取
  - 实现规则条件评估
  - 实现按顺序匹配逻辑

- [x] **实现SmartPresetLoader**
  - 创建 `utils/smart_preset_loader.py`
  - 实现预设文件加载
  - 实现智能分类调用
  - 实现错误处理和回退

#### 第二阶段：集成到ApplicationContext ✅
- [x] **修改load_image方法**
  - 集成智能预设加载器
  - 新文件加载时自动应用智能分类默认设置
  - 保持现有自动预设逻辑

- [x] **修改reset_params方法**
  - 重置时根据文件类型选择智能默认预设
  - 支持fff文件的特殊默认设置

- [x] **修改crop重置逻辑**
  - crop聚焦重置时继承接触印相设置
  - 没有接触印相设置时使用智能分类默认
  - 保持现有crop管理逻辑

#### 第三阶段：测试和优化 ✅
- [x] **功能测试**
  - 测试fff文件的自动分类
  - 测试其他文件类型的分类
  - 测试规则顺序优先级

- [x] **场景测试**
  - 测试新文件加载场景
  - 测试重置参数场景
  - 测试crop聚焦重置场景

- [x] **错误处理测试**
  - 测试配置文件损坏情况
  - 测试预设文件缺失情况
  - 测试分类器异常情况

### 技术特点
1. **完全解耦**：分类器和加载器独立工作，不依赖ApplicationContext
2. **规则驱动**：所有分类逻辑都在配置文件中定义
3. **顺序优先级**：按rules.json中的顺序决定匹配优先级
4. **灵活匹配**：支持扩展名、关键词、路径等多种匹配方式
5. **智能回退**：分类失败时自动回退到通用默认设置

### 使用场景覆盖
- **新文件加载**：自动应用智能分类默认设置
- **重置设置**：根据文件类型选择相应的默认预设
- **crop聚焦重置**：继承接触印相设置，保持一致性

### 文件结构
```
divere/
├── config/
│   ├── file_classification_rules.json  # 分类规则配置
│   └── defaults/                       # 默认预设文件夹
│       ├── default_imacon.json        # fff文件默认预设
│       ├── default_scanner.json       # 专业扫描仪默认预设
│       ├── default_film.json          # 胶片扫描默认预设
│       └── default.json               # 通用默认预设
├── utils/
│   ├── path_manager.py                # 路径管理器（addpath方式）
│   ├── smart_file_classifier.py       # 文件分类器
│   └── smart_preset_loader.py         # 预设加载器
├── standalone_tools/                   # 独立工具包
│   ├── __init__.py
│   ├── file_classification_manager.py # 文件分类规则管理器UI
│   └── launcher.py                    # 工具启动器
├── core/
│   └── app_context.py                 # 集成智能分类系统
└── ui/
    └── main_window.py                 # 主窗口（集成工具菜单）
```

## 新增任务：文件分类规则管理器UI 🆕

### 优化目标
- 提供图形化界面来管理文件分类规则
- 支持新建、删除、编辑规则
- 支持预设文件的创建、编辑和管理
- 集成到主程序的工具菜单中

## 重构任务：统一默认文件管理和路径管理 🔄

### 重构目标
- 将所有default文件统一放到`config/defaults`文件夹中
- 使用`addpath`方式管理各种配置和资源路径
- 创建统一的路径管理器，提供便捷的路径查找和解析功能
- 重构所有相关模块，使用新的路径管理方式

### 具体任务

#### 第一阶段：文件结构重构 ✅
- [x] **创建defaults文件夹**
  - 创建 `config/defaults` 文件夹
  - 移动所有default文件到新位置

- [x] **实现路径管理器**
  - 创建 `utils/path_manager.py`
  - 实现addpath方式的路径管理
  - 支持多种路径类别和文件查找

#### 第二阶段：模块重构 ✅
- [x] **更新智能文件分类器**
  - 使用新的路径管理器
  - 更新配置文件路径引用

- [x] **更新智能预设加载器**
  - 使用新的路径管理器
  - 支持相对路径解析

- [x] **更新ApplicationContext**
  - 使用新的路径管理器
  - 重构默认预设加载逻辑

- [x] **更新文件分类规则管理器UI**
  - 使用新的路径管理器
  - 更新预设文件扫描逻辑

#### 第三阶段：测试和验证 ✅
- [x] **路径管理器测试**
  - 验证路径查找功能
  - 验证文件解析功能
  - 验证默认预设列表功能

- [x] **编译测试**
  - 所有模块编译通过
  - 路径引用正确

### 具体任务

#### 第一阶段：核心UI实现 ✅
- [x] **创建独立工具包结构**
  - 创建 `standalone_tools` 文件夹
  - 实现模块化工具架构

- [x] **实现文件分类规则管理器**
  - 创建 `FileClassificationManager` 主窗口
  - 实现规则列表和编辑界面
  - 实现条件管理（类型、操作符、值）
  - 实现预设文件管理

- [x] **实现工具启动器**
  - 创建 `ToolsLauncher` 统一接口
  - 提供便捷的启动函数

#### 第二阶段：主程序集成 ✅
- [x] **集成到主窗口菜单**
  - 在"工具"菜单中添加"文件分类规则管理器"
  - 实现菜单项的事件处理

#### 第三阶段：功能完善
- [ ] **预设文件表格显示**
  - 在右侧面板显示预设文件列表
  - 支持预设文件的快速操作

- [ ] **规则验证和提示**
  - 添加规则有效性验证
  - 提供用户友好的错误提示

- [ ] **界面优化**
  - 优化布局和样式
  - 添加键盘快捷键支持
